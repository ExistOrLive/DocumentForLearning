# 类的加载下

## 1. 分类中的Mach-O结构

**分类的加载** 本质上是将**分类**中定义的**方法**，**属性** 以及 **实现的协议** 加入到运行时的 **类对象中**。

如果原始**类**和其**分类**在同一个库中，那么在编译时就可能会优化，将**分类**中的数据直接加入**类**数据中。

```objc 
// 定义如下的类和分类
@interface LGPerson : NSObject
- (void) sayHello3;
- (void) sayHello1;
- (void) sayHello;
@property(nonatomic, strong) NSString *name;
@end

@implementation LGPerson
- (void)sayHello3{    
}
- (void)sayHello{
}
- (void)sayHello1{
}
@end


@interface LGPerson (LGA)
- (void) LGA;
@end

@implementation LGPerson (LGA)
- (void) LGA{
}
@end

```

可以在 Mach-O 文件中看到， `LGPerson` 类数据中已经包含了分类中的方法, 对于这样的分类在加载时只需要加载类的信息。

![](https://gitee.com/existorlive/exist-or-live-pic/raw/master/%E6%88%AA%E5%B1%8F2021-06-05%20%E4%B8%8A%E5%8D%883.02.01.png)

```objc 
// 定义如下的类和分类
// 类和分类都实现 +load 方法
@interface LGPerson : NSObject
- (void) sayHello3;
- (void) sayHello1;
- (void) sayHello;
@property(nonatomic, strong) NSString *name;
@end

@implementation LGPerson
+ (void) load{
}
- (void)sayHello3{    
}
- (void)sayHello{
}
- (void)sayHello1{
}
@end


@interface LGPerson (LGA)
- (void) LGA;
@end

@implementation LGPerson (LGA)
+ (void) load{
}
- (void) LGA{
}
@end

```

可以在 Mach-O 文件中看到， `LGPerson` 类数据中没有包含了分类`LGA`中的方法; 而分类`LGA`信息在 **__objc_catlist** 段中。
对于这样的分类，再加载完类信息之后还需要加载分类信息。

![](https://gitee.com/existorlive/exist-or-live-pic/raw/master/%E6%88%AA%E5%B1%8F2021-06-05%20%E4%B8%8A%E5%8D%883.33.08.png)

![](https://gitee.com/existorlive/exist-or-live-pic/raw/master/%E6%88%AA%E5%B1%8F2021-06-05%20%E4%B8%8A%E5%8D%883.33.37.png)

在同一个库中，尽管有些分类的信息会编译在类的信息中；但是考虑到**类**和**分类**在不同库中的情况，其实在加载分类才是相对重要需要研究的部分。

## 2. 分类加载进内存的时机





