# GPU图形渲染流水线

在可视化的计算机系统中，应用的运行首先是依赖**CPU**进行流程处理和UI布局，**CPU**将计算好的**图元数据**和**纹理数据**交由**GPU**处理，而**GPU**会**图元数据**和**纹理数据**渲染为可用于显示器显示的一帧帧的**像素**数据。

![](https://pic.existorlive.cn/%E6%88%AA%E5%B1%8F2020-12-18%20%E4%B8%8A%E5%8D%882.47.31.png)

GPU渲染图形的整个流程称为**GPU图形渲染流水线**，由一个个**着色器**组成，**着色器**可以理解为渲染流水线中的每个环节。部分着色器是可以编程的，就像是函数一样。着色器可以使用多种语言编写，**OpenGL** 提供了 **GLSL（OpenGL Shading Language）** 着色器语言。

**GPU图形渲染流水线**的具体实现可分为六个阶段，如下图所示。

- 顶点着色器（Vertex Shader）
- 形状装配（Shape Assembly），又称 图元装配
- 几何着色器（Geometry Shader）
- 光栅化（Rasterization）
- 片段着色器（Fragment Shader）
- 测试与混合（Tests and Blending）

![](https://pic.existorlive.cn/opengl-graphics-pipeline.png)


第一阶段，**顶点着色器**。该阶段的输入是 **顶点数据（Vertex Data） 数据**，比如以数组的形式传递 3 个 3D 坐标用来表示一个三角形。顶点数据是一系列顶点的集合。顶点着色器主要的目的是把 3D 坐标转为另一种 3D 坐标，同时顶点着色器可以对顶点属性进行一些基本处理。

第二阶段，**形状（图元）装配**。该阶段将顶点着色器输出的所有顶点作为输入，并将所有的点装配成指定图元的形状。图中则是一个三角形。图元（Primitive） 用于表示如何渲染顶点数据，如：点、线、三角形。

第三阶段，**几何着色器**。该阶段把图元形式的一系列顶点的集合作为输入，它可以通过产生新顶点构造出新的（或是其它的）图元来生成其他形状。例子中，它生成了另一个三角形。

第四阶段，**光栅化**。该阶段会把图元映射为最终屏幕上相应的像素，生成片段。片段（Fragment） 是渲染一个像素所需要的所有数据。

第五阶段，**片段着色器**。该阶段首先会对输入的片段进行 裁切（Clipping）。裁切会丢弃超出视图以外的所有像素，用来提升执行效率。图片视频等纹理数据也会在这一阶段处理。

第六阶段，**测试与混合**。该阶段会检测片段的对应的深度值（z 坐标），判断这个像素位于其它物体的前面还是后面，决定是否应该丢弃。此外，该阶段还会检查 alpha 值（ alpha 值定义了一个物体的透明度），从而对物体进行混合。因此，即使在片段着色器中计算出来了一个像素输出的颜色，在渲染多个三角形的时候最后的像素颜色也可能完全不同。


